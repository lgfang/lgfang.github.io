---
layout: post
title: Shell Command Line Interpretation and the "eval" Command
tagline:
categories: computer
tags: [quoting, bash, shell, coding]
---

<p>
In a <a href="http://lgfang.github.io/computer/2014/09/07/sh-quotes-escape">previous post</a> I explained that understanding what shell does under the hood
(i.e. "there are three steps" section) is the key to understand most issues that
are related with quotes. This blog is to reiterate it, with another scenario.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">A use case</h2>
<div class="outline-text-2" id="text-1">
<p>
Some people like to compose and run commands dynamically like this:
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr">1: </span><span class="org-keyword">if</span> a; <span class="org-keyword">then</span>
<span class="linenr">2: </span>    <span class="org-variable-name">cmd</span>=cmd_a
<span class="linenr">3: </span><span class="org-keyword">else</span>
<span class="linenr">4: </span>    <span class="org-variable-name">cmd</span>=cmd_b
<span class="linenr">5: </span><span class="org-keyword">fi</span>
<span class="linenr">6: </span>
<span class="linenr">7: </span>$<span class="org-variable-name">cmd</span>
</pre>
</div>

<p>
Though this works in many cases, please be warned that it may fail when
<code>cmd_a</code> and/or <code>cmd_b</code> are complex. That is the case when <code>eval</code> shall be
used. See the snippet below for an example.
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">echo</span> <span class="org-string">'a   b'</span>
<span class="org-variable-name">cmd</span>=<span class="org-string">"echo 'a   b'"</span>
$<span class="org-variable-name">cmd</span>                            <span class="org-comment-delimiter"># </span><span class="org-comment">!= echo 'a   b'</span>
<span class="org-builtin">eval</span> <span class="org-string">"$cmd"</span>                     <span class="org-comment-delimiter"># </span><span class="org-comment">== echo 'a   b'</span>
</pre>
</div>

<p>
Obviously, real-world cases will not be so simple and explicit. One issue we
met in our project was:
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-variable-name">base_dn</span>=<span class="org-string">'cn=Request Processors,cn=config'</span>
<span class="org-variable-name">cmd</span>=<span class="org-string">"ldapsearch -h localhost -b '$base_dn' 'objectclass=*'"</span>
<span class="org-variable-name">result</span>=$($<span class="org-variable-name">cmd</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, error message: The provided search filter contains an</span>
               <span class="org-comment-delimiter"># </span><span class="org-comment">invalid attribute type 'Processors,cn' with invalid character</span>
               <span class="org-comment-delimiter"># </span><span class="org-comment">',' at position 10"</span>
<span class="org-variable-name">result</span>=$(<span class="org-sh-quoted-exec">eval</span> <span class="org-string">"$cmd"</span>)           <span class="org-comment-delimiter"># </span><span class="org-comment">OK</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">The Three Steps</h2>
<div class="outline-text-2" id="text-2">
<p>
To answer why sometimes <code>eval</code> is necessary while at other times it makes no
difference, let review the interpretation of command lines first.
</p>

<p>
Any command line you typed in CLI or shell scripts is dealt with in the
following steps:
</p>

<ol class="org-ol">
<li>The shell, if applicable, does expansion and substitution.
</li>
<li>The shell interprets the cooked command line, i.e. evokes designated
command and feeds it with inputs.
</li>
<li>The command runs and handles the inputs it gets.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">The case study</h2>
<div class="outline-text-2" id="text-3">
<p>
With those three steps in mind, now we study the aforementioned case.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">The normal case</h3>
<div class="outline-text-3" id="text-3-1">
<pre class="example">
echo 'a   b'
</pre>

<ol class="org-ol">
<li>The shell does expansion and substitution etc.

<ul class="org-ul">
<li>There is NO expansion and substitution.
</li>

<li>The shell sees the single quotes, therefore it takes <code>a___b</code> as a
literal string.
</li>
</ul>
</li>

<li>The shell interprets the command line

<p>
The shell sees the command line as: string "echo" + IFS + string "a___b"
(without enclosing quotes). Therefore, the shell launches the first part
(i.e. "echo") and feeds the second part to "echo" as the first argument.
</p>
</li>

<li>Command runs

<p>
The "echo" prints <code>a___b</code> (the only argument it receives) to stdout.
</p>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">The <code>$cmd</code> case</h3>
<div class="outline-text-3" id="text-3-2">
<pre class="example">
$cmd
</pre>

<ol class="org-ol">
<li>Expansion and substitution

<ul class="org-ul">
<li>The shell does NOT see any quotes.
</li>

<li>It sees <code>$cmd</code> and replace it with the value of "cmd", that is string:
<pre class="example">
echo 'a   b'
</pre>
</li>
</ul>
</li>

<li>Interpretation

<p>
Since <b>the quotes are results of substitution, they are taken literally</b>.
Hence, what the shell sees are: string "echo" + IFS + string "'a" (single
quote &amp; character a) + IFS + string "b'" (b &amp; a single quote). Therefore,
the shell launches "echo" with two arguments: "'a" and "b'".
</p>
</li>

<li>Command run

<p>
The "echo" , printed "'a" and "b'" on screen respectively, with a space
(default delimiter for outputs) between them.
</p>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">The "eval"</h3>
<div class="outline-text-3" id="text-3-3">
<pre class="example">
eval "$cmd"
</pre>

<p>
The "eval" is basically to make shell do the parsing process one more time.
</p>

<ol class="org-ol">
<li>Expansion and substitution

<ul class="org-ul">
<li>The shell sees a pair of double quotes, hence take everything (after
expansion and substitution) enclosed by them as a string literal.
</li>

<li>It replace <code>$cmd</code> with value of variable <code>cmd</code>.
</li>
</ul>
</li>

<li>Interpretation

<p>
The shell sees string "eval" + IFS + string "echo 'a___b'".
</p>
</li>

<li>Command run

<p>
"eval" gets one arguments, that is the "echo 'a___b'" string. It then goes
through the three-step procedure against this string:
</p>

<ol class="org-ol">
<li>Expansion and substitution

<ul class="org-ul">
<li>There are single quotes, so "a", "b" and spaces between them are
taken literal.
</li>

<li>No expansion/substitution.
</li>
</ul>
</li>

<li>Interpretation

<p>
The shell sees "echo" + IFS + "a___b".
</p>
</li>

<li>Command run

<p>
"echo" prints "a___b" to stdout.
</p>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Quiz</h2>
<div class="outline-text-2" id="text-4">
<p>
Think about what <code>eval $cmd</code> will print and explain why.
</p>
</div>
</div>
