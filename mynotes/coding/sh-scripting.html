<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Shell as a Scripting Language</title>
<!-- 2016-08-01 Mon 15:02 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Fang Lungang" />
<link rel="stylesheet" type="text/css" href="../cssjs/lgfang.css" />

<script type="text/javascript" src="../cssjs/org-info.js">
/**
 *
 * @source: ../cssjs/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in ../cssjs/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in ../cssjs/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "2");
org_html_manager.set("LINK_HOME", "../../index.html");
org_html_manager.set("LINK_UP", "../index.html");
org_html_manager.set("LOCAL_TOC", "0");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "showall");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div class="container-narrow">
<div id="content">
<h1 class="title">Shell as a Scripting Language</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a>
<ul>
<li><a href="#sec-1-1">1.1. Shell scripting makes our lives easier</a></li>
<li><a href="#sec-1-2">1.2. It is no picnic</a></li>
<li><a href="#sec-1-3">1.3. How to learn</a></li>
<li><a href="#sec-1-4">1.4. Do not ask for trouble</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Deal with Errors</a>
<ul>
<li><a href="#sec-2-1">2.1. Prevent coding errors</a></li>
<li><a href="#sec-2-2">2.2. Catch errors at run time</a></li>
<li><a href="#sec-2-3">2.3. Coding for debugging</a></li>
<li><a href="#sec-2-4">2.4. Debug</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Shell expansion</a>
<ul>
<li><a href="#sec-3-1">3.1. Understand what a command expects</a></li>
<li><a href="#sec-3-2">3.2. Wrong commands may or may not get expected result</a></li>
<li><a href="#sec-3-3">3.3. Special characters in result of shell expansion may cause issues</a></li>
<li><a href="#sec-3-4">3.4. Special characters in input string may cause issue</a></li>
<li><a href="#sec-3-5">3.5. Use quotes and escape characters correctly</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Pipe</a>
<ul>
<li><a href="#sec-4-1">4.1. Make programs filters</a></li>
<li><a href="#sec-4-2">4.2. Always set pipefail</a></li>
<li><a href="#sec-4-3">4.3. Piped blocks run in subshell</a></li>
<li><a href="#sec-4-4">4.4. Pipe sign is a sequence point</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Input and output</a>
<ul>
<li><a href="#sec-5-1">5.1. stdout != stderr</a></li>
<li><a href="#sec-5-2">5.2. Temporary files</a></li>
<li><a href="#sec-5-3">5.3. Use "Here Document"</a></li>
<li><a href="#sec-5-4">5.4. getopts</a></li>
<li><a href="#sec-5-5">5.5. read</a></li>
<li><a href="#sec-5-6">5.6. select</a></li>
<li><a href="#sec-5-7">5.7. Open/close file descriptors</a>
<ul>
<li><a href="#sec-5-7-1">5.7.1. Note for ksh</a></li>
<li><a href="#sec-5-7-2">5.7.2. Wholes in files</a></li>
</ul>
</li>
<li><a href="#sec-5-8">5.8. tee to file descriptors (fd)</a></li>
<li><a href="#sec-5-9">5.9. Truncate files</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Variables</a>
<ul>
<li><a href="#sec-6-1">6.1. There is NO type</a></li>
<li><a href="#sec-6-2">6.2. Attributes of variables</a></li>
<li><a href="#sec-6-3">6.3. indirect expansion</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Processes</a>
<ul>
<li><a href="#sec-7-1">7.1. Shebang</a></li>
<li><a href="#sec-7-2">7.2. SUID does not work with scripts</a></li>
<li><a href="#sec-7-3">7.3. Evoke correct programs</a></li>
<li><a href="#sec-7-4">7.4. Command line has length limitation</a></li>
<li><a href="#sec-7-5">7.5. Inter-process lock</a>
<ul>
<li><a href="#sec-7-5-1">7.5.1. Note for ksh</a></li>
</ul>
</li>
<li><a href="#sec-7-6">7.6. Timeout a process</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Misc</a>
<ul>
<li><a href="#sec-8-1">8.1. Use better syntax/notation</a></li>
<li><a href="#sec-8-2">8.2. Regular expressions are greedy</a></li>
<li><a href="#sec-8-3">8.3. Number literals not necessarily decimals</a></li>
<li><a href="#sec-8-4">8.4. Command outputs may vary according env and result</a></li>
<li><a href="#sec-8-5">8.5. Avoid name space contamination by running in subshells</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Q&amp;A</a></li>
<li><a href="#sec-10">10. Misc. Techniques</a>
<ul>
<li><a href="#sec-10-1">10.1. Shell parameter expansion</a></li>
<li><a href="#sec-10-2">10.2. Brace expansion</a></li>
<li><a href="#sec-10-3">10.3. Make use of Non-op colon(:)</a></li>
<li><a href="#sec-10-4">10.4. Get N-th field</a></li>
<li><a href="#sec-10-5">10.5. Tell if A is an element of B</a></li>
<li><a href="#sec-10-6">10.6. Return values from functions</a></li>
<li><a href="#sec-10-7">10.7. Logging functions</a></li>
<li><a href="#sec-10-8">10.8. Wrappers for ssh</a></li>
<li><a href="#sec-10-9">10.9. Ask for users confirm</a></li>
<li><a href="#sec-10-10">10.10. To tell if a bash function exists or not</a></li>
<li><a href="#sec-10-11">10.11. To tell if it is an interactive shell</a></li>
<li><a href="#sec-10-12">10.12. Socket</a></li>
<li><a href="#sec-10-13">10.13. Use of "shortcut" expressions</a>
<ul>
<li><a href="#sec-10-13-1">10.13.1. Continue with next command until one fails</a></li>
<li><a href="#sec-10-13-2">10.13.2. Try commands in turn until one succeeded:</a></li>
<li><a href="#sec-10-13-3">10.13.3. Run either cmd2 or cmd3 according to result of cmd1</a></li>
<li><a href="#sec-10-13-4">10.13.4. If either cmd1 or cmd2 succeeded, run cmd3.</a></li>
</ul>
</li>
<li><a href="#sec-10-14">10.14. Why not "basename"</a></li>
<li><a href="#sec-10-15">10.15. Array</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Shell scripting makes our lives easier</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Address real-world issues by one-liners:
</p>

<ul class="org-ul">
<li>Delete confict ssh key

<div class="org-src-container">

<pre class="src src-shell-script">sed -i 5d ~/.ssh/known_hosts
</pre>
</div>
</li>

<li>Retry
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">while</span> heat stack-list | grep -q UPDATE_IN_PROGRESS; <span class="org-keyword">do</span> sleep 30; <span class="org-keyword">done</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Beep to alert you after it is done</span>
<span class="org-keyword">for</span> i<span class="org-keyword"> in</span> {1..30}; <span class="org-keyword">do </span><span class="org-builtin">echo</span> -ne <span class="org-string">"\a"</span>; sleep 1; <span class="org-keyword">done</span>
</pre>
</div>
</li>

<li>Deliver patched files to labs
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">for</span> each<span class="org-keyword"> in</span> $(<span class="org-sh-quoted-exec">nova</span> list | grep 0-0-1 | grep -o <span class="org-string">'prov3-net=[^; ]*'</span> | cut -d<span class="org-string">'='</span> -f 2); <span class="org-keyword">do</span> scp 8661ConfigSNMP.sh $<span class="org-variable-name">each</span>:/apps/snmp/8661ConfigSNMP.sh; <span class="org-keyword">done</span>
</pre>
</div>
</li>

<li>Delete duplicated files
<div class="org-src-container">

<pre class="src src-shell-script">find . -path <span class="org-string">'*/DIAM/*/*'</span> -exec md5sum {} <span class="org-string">\;</span> | awk <span class="org-string">'{files[$1]++;} files[$1]&gt;1{system("rm "$2)}'</span>
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> It is no picnic</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Easy to learn, hard to grasp
</p>

<ul class="org-ul">
<li>Mastering shell == Mastering loads of command line tools
<ul class="org-ul">
<li>sed, awk, find, grep, ssh, netstat/ss/sn, df, &#x2026;
</li>
</ul>
</li>

<li>A number of pitfalls and portability issues
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> How to learn</h3>
<div class="outline-text-3" id="text-1-3">
<p>
It is a programming language, NOT a simple tool
</p>

<ul class="org-ul">
<li>Read a book which teaches you shell scripting systematically.
<ul class="org-ul">
<li>Learning from examples is NOT adequate.
</li>
</ul>
</li>

<li>Clear understanding is the key
</li>

<li>Make good use of the (info "(bash)")

<p>
For instance, what does <code>|&amp;</code> mean and why <code>[ -f a.* ]</code> "works as expected" but <code>[ [ -f
     a.* ]]</code> does not (<a href="http://lgfang.github.io/computer/2015/08/15/bash-understanding-test-extension/">more discussion</a>)?
</p>
</li>

<li>Hone your skills by using them in your daily work.
<ul class="org-ul">
<li>Listen to a lecture or two does NOT make you a shell expert.
</li>
<li>Time-consuming it might be at first, it will pay off very soon
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Do not ask for trouble</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Script in <code>ksh</code> or <code>bash</code>, stay away from <code>csh</code>
</li>

<li>Many scripts just written and thrown
</li>

<li>Use shell scripts as a glue layer only
<ul class="org-ul">
<li>Use Python/TCL etc. for complex tasks
</li>
</ul>
</li>

<li>Comply with conventions and traditions.

<p>
E.g. exit code 0 for success, non-zero for failure.
</p>
</li>

<li>Group code into <b>small</b> functions.
</li>

<li>Check exit code.
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Deal with Errors</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Prevent coding errors</h3>
<div class="outline-text-3" id="text-2-1">
<p>
You don't have to wait until bugs got you at run time.
</p>

<ul class="org-ul">
<li><code>bash -n test.sh</code>
<ul class="org-ul">
<li>Builtin, simplistic syntax checker.
</li>
<li>sh and ksh also support this.
</li>
</ul>
</li>

<li><a href="http://www.shellcheck.net/about.html">shellcheck</a> <b>strongly recommended</b>
<ul class="org-ul">
<li>A static analysis and linting tool for sh/bash scripts.
</li>

<li>Has as <a href="http://www.shellcheck.net/">web for online validation</a>
</li>

<li>Can be integrated into vim/emacs.

<p>
Demo: edit the following script in emacs on hpds09 to show how flycheck
with shellcheck works.
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

<span class="org-keyword">if</span> [ -f test.* ]; <span class="org-keyword">then </span><span class="org-builtin">echo</span> ok; <span class="org-keyword">fi</span>

<span class="org-keyword">if</span> [ a =~ test.* ]; <span class="org-keyword">then </span><span class="org-builtin">echo</span> ok; <span class="org-keyword">fi</span>

ssh user@remote <span class="org-string">"echo $PWD"</span>

<span class="org-variable-name">shall_we_continue</span>=true; <span class="org-builtin">echo</span> shall_we_contiune

<span class="org-keyword">function</span> <span class="org-function-name">my_fun</span> {
    <span class="org-builtin">echo</span> $<span class="org-variable-name">1</span>
}

result = $(<span class="org-sh-quoted-exec">my_fun</span>)
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Catch errors at run time</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Set nounset

<p>
<code>set -o nounset</code> (or <code>set -u</code>)
</p>

<p>
Raise errors for use of unbound shell variables (neither defined locally
nor imported).
</p>
</li>

<li>Set errexit

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">set</span> -o errexit <span class="org-comment-delimiter"># </span><span class="org-comment">or "set -e"</span>
</pre>
</div>

<p>
<b>NOTE:</b> Better use it during test and debug only because, in production
environment, you may need more control. For example, <code>result=$(cmd); if [
     $? -ne 0 ]; then ...; fi</code>
</p>
</li>

<li>Trap signals etc.

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

<span class="org-keyword">function</span> <span class="org-function-name">sigHandler</span> {
  date
}
<span class="org-keyword">trap</span> sigHandler SIGINT SIGTERM SIGHUP

<span class="org-keyword">trap</span> <span class="org-string">"echo done"</span> EXIT
<span class="org-keyword">trap</span> <span class="org-string">"echo error occured"</span> ERR

<span class="org-keyword">trap</span> SIGTERM                    <span class="org-comment-delimiter"># </span><span class="org-comment">reset handler</span>
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Coding for debugging</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Do NOT discard stderr without good reason

<div class="org-src-container">

<pre class="src src-shell-script">my_cmd &gt;/dev/null 2&gt;&amp;1          <span class="org-comment-delimiter"># </span><span class="org-comment">NOOOOOO!</span>
</pre>
</div>

<p>
Error message you discarded can be vital for debugging.
</p>
</li>

<li>Logging for debug

<p>
Deliberately designed log is much superior then single-step debug.
</p>

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">make use of the fact that `true' and 'false' are valid commands</span>
<span class="org-variable-name">DEBUG_ON</span>=false

<span class="org-keyword">function</span> <span class="org-function-name">debug</span> {
    <span class="org-keyword">if</span> $<span class="org-variable-name">DEBUG_ON</span>; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"DEBUG: $*"</span> | tee -a $<span class="org-variable-name">LOG_FILE</span>
    <span class="org-keyword">fi</span>
}
</pre>
</div>
</li>

<li>Command wrapper

<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr"> 1: </span><span class="org-comment-delimiter"># </span><span class="org-comment">report file name and line number, USE WITH CAUTIOUS</span>
<span class="linenr"> 2: </span><span class="org-keyword">function</span> <span class="org-function-name">run_cmd</span> {
<span class="linenr"> 3: </span>    <span class="org-string">"$@"</span>
<span class="linenr"> 4: </span>    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
<span class="linenr"> 5: </span>        <span class="org-builtin">echo</span> <span class="org-string">"ERR: FILE: ${BASH_SOURCE[1]} LINE: ${BASH_LINENO[0]}"</span>
<span class="linenr"> 6: </span>        <span class="org-keyword">exit</span> 1
<span class="linenr"> 7: </span>    <span class="org-keyword">fi</span>
<span class="linenr"> 8: </span>}
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>run_cmd touch <span class="org-string">"./path/non-exists/b"</span>
<span class="linenr">11: </span>
<span class="linenr">12: </span><span class="org-comment-delimiter"># </span><span class="org-comment"># Less convenient, but also works in ksh</span>
<span class="linenr">13: </span><span class="org-comment-delimiter"># </span><span class="org-comment">SCRIPT_NAME=$(</span><span class="org-sh-quoted-exec">basename</span><span class="org-comment"> $0)</span>
<span class="linenr">14: </span><span class="org-comment-delimiter"># </span><span class="org-comment">echo "ERR: FILE: $SCRIPT_NAME LINE: $LINENO" &gt;&amp;2</span>
</pre>
</div>

<pre class="example">
$ ./test.sh
touch: cannot touch `./path/non-exists/b': No such file or directory
ERR: FILE: ./test.sh LINE: 10
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Debug</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li><code>set -x</code> and PS4

<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr">1: </span><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class="org-keyword">function</span> <span class="org-function-name">my_fun</span> {
<span class="linenr">4: </span>        <span class="org-builtin">echo</span> this is my <span class="org-keyword">function</span>
<span class="linenr">5: </span>}
<span class="linenr">6: </span>
<span class="linenr">7: </span>my_fun
</pre>
</div>

<pre class="example">
$ PS4='Line ${LINENO}: ' bash -x test.sh
Line 7: my_fun
Line 4: echo this is my function
this is my function
</pre>

<p>
Or, add the following snippet into your script:
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">export</span> <span class="org-variable-name">PS4</span>=<span class="org-string">'+ ${LINENO}: '</span>
<span class="org-builtin">set</span> -x
</pre>
</div>
</li>

<li>Trap error

<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr">1: </span><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="linenr">2: </span><span class="org-builtin">set</span> -o errexit
<span class="linenr">3: </span><span class="org-keyword">trap</span> <span class="org-string">'echo error at $LINENO: $var'</span> ERR
<span class="linenr">4: </span>
<span class="linenr">5: </span><span class="org-variable-name">var</span>=<span class="org-string">"hi there"</span>
<span class="linenr">6: </span><span class="org-builtin">echo</span> $<span class="org-variable-name">var</span> | sed <span class="org-string">'oops'</span>
<span class="linenr">7: </span><span class="org-builtin">echo</span> <span class="org-string">'done'</span>
</pre>
</div>

<pre class="example">
$ ./test.sh
sed: -e expression #1, char 1: unknown command: `o'
error at 6: hi there
</pre>
</li>

<li>Set quit point

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

<span class="org-keyword">function</span> <span class="org-function-name">quit_point</span> {
    <span class="org-comment-delimiter"># </span><span class="org-comment">This is to abort a script intentionally during tests.</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Usage: add lines some like the following into shell scripts</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">quit_point [once] [whatever notes ...]</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">If the first argument is string "once", the quit_point quits only once.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">I.e, the line will be commented out after being hit.</span>

    <span class="org-builtin">local</span> <span class="org-variable-name">temporary</span>=$<span class="org-variable-name">1</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">file</span>=${<span class="org-variable-name">BASH_SOURCE</span>[1]}
    <span class="org-builtin">local</span> <span class="org-variable-name">line</span>=${<span class="org-variable-name">BASH_LINENO</span>[0]}
    <span class="org-builtin">echo</span> <span class="org-string">"Quit point: $file::$line $*"</span>
    [ <span class="org-string">"$temporary"</span> == <span class="org-string">"once"</span> ] || sed -i <span class="org-string">"${line}s/^/#/"</span> $<span class="org-variable-name">file</span>
    <span class="org-keyword">exit</span> 1
}
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Shell expansion</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Understand what a command expects</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">

<pre class="src src-shell-script">ls *.txt                        <span class="org-comment-delimiter"># </span><span class="org-comment">:)</span>
ls <span class="org-string">'*.txt'</span>                      <span class="org-comment-delimiter"># </span><span class="org-comment">:(</span>
find . -iname *.txt             <span class="org-comment-delimiter"># </span><span class="org-comment">:(</span>
find . -iname <span class="org-string">'*.txt'</span>           <span class="org-comment-delimiter"># </span><span class="org-comment">:)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Wrong commands may or may not get expected result</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Surroundings changes meaning of command
</p>

<pre class="example">
$ ls

$ echo 'hi there' | tr [a-z] [A-Z]
HI THERE

$ touch a

$ echo 'hi there' | tr [a-z] [A-Z]
hi there

$ touch a b

$ echo 'hi there' | tr [a-z] [A-Z]
tr: extra operand `b'
Try `tr --help' for more information.
</pre>

<p>
Some other WRONG commands
</p>
<div class="org-src-container">

<pre class="src src-shell-script">[ -f a.* ]
[ $<span class="org-variable-name">var</span> -eq 0 ]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Special characters in result of shell expansion may cause issues</h3>
<div class="outline-text-3" id="text-3-3">
<pre class="example">
$ touch -- -j

$ ls
a  b  -j

$ ls *
ls: unknown option -- j
Try `ls --help' for more information.

$ ls -- *
a  b  -j

$ ls ./*
./a  ./b  ./-j
</pre>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Special characters in input string may cause issue</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">

<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/env python</span>
<span class="org-keyword">import</span> os
<span class="org-keyword">import</span> commands
<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> == <span class="org-string">'__main__'</span>:
    <span class="org-variable-name">log_str</span> = <span class="org-string">"this is a `test'"</span>
    os.system(<span class="org-string">'echo "%s"'</span> % log_str)
</pre>
</div>

<pre class="example">
$ cat test.py
$ ./test.py
sh: -c: line 0: unexpected EOF while looking for matching ``'
sh: -c: line 1: syntax error: unexpected end of file
</pre>

<p>
This is based on a real-world bug. Since the log_str varies for each run,
this kind of issue is harder to debug.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Use quotes and escape characters correctly</h3>
<div class="outline-text-3" id="text-3-5">
<p>
<a href="http://lgfang.github.io/computer/2014/09/07/sh-use-quotes/">Using Quotes Makes Your Scripts More Robust</a>
</p>

<p>
<a href="http://lgfang.github.io/computer/2014/09/07/sh-quotes-escape/">Understanding Quoting and Escaping in Bash Scripts</a>
</p>

<p>
TODO:
</p>

<div class="org-src-container">

<pre class="src src-shell-script">ssh user@remote <span class="org-string">"cmd ..."</span>

ssh user@remote <span class="org-string">"cmd ... | grep ..."</span>
ssh user@remote <span class="org-string">"cmd ..."</span> | grep ...
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Pipe</h2>
<div class="outline-text-2" id="text-4">

<div class="figure">
<p><img src="pipe-illustrated.png" alt="pipe-illustrated.png" />
</p>
</div>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Make programs filters</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Eliminate the need of interim files
</li>

<li>Flexible
</li>

<li>Extensible (combine tools)
</li>

<li>Don't underestimate these benefits!

<p>
Here are some examples
</p>
<ul class="org-ul">
<li>Streaming video

<div class="org-src-container">

<pre class="src src-shell-script">wget ftp://qdcvs/input.avi -O - | mplayer -
</pre>
</div>
</li>

<li>Call remote functions "locally"

<div class="org-src-container">

<pre class="src src-shell-script">cat ./conf.rnc | ssh me@1.2.31.61 <span class="org-string">'java -jar ./trang.jar'</span> &gt; ./conf.rng
</pre>
</div>

<p>
Compare above command line with the following one which is without pipe
support.
</p>

<div class="org-src-container">

<pre class="src src-shell-script">scp ./conf.rnc me@1.2.31.61:./ <span class="org-sh-escaped-newline">\</span>
    &amp;&amp; ssh me@1.2.31.61 <span class="org-string">'java -jar /trang.jar conf.rnc conf.rng'</span> <span class="org-sh-escaped-newline">\</span>
    &amp;&amp; scp me@1.2.31.61:./conf.rng ./
</pre>
</div>
</li>

<li>New usage of an old script

<p>
These commands combine to prepare a word bank for English contest. But none
of them was designed fro that.
</p>

<div class="org-src-container">

<pre class="src src-shell-script">cat input1 input2 <span class="org-sh-escaped-newline">\</span>
    | tr <span class="org-string">' '</span> <span class="org-string">'\n'</span> <span class="org-sh-escaped-newline">\</span>
    | grep -o <span class="org-string">'[A-Za-z][A-Za-z][a-zA-Z]*'</span> <span class="org-sh-escaped-newline">\</span>
    | sort -u <span class="org-sh-escaped-newline">\</span>
    | mydraft <span class="org-sh-escaped-newline">\</span>
    | grep -v <span class="org-string">"\(Please\|Lucky\) "</span> <span class="org-sh-escaped-newline">\</span>
    | head -6
</pre>
</div>
</li>

<li>Transfer files to a host hops away


<div class="figure">
<p><img src="pipe-example.png" alt="pipe-example.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">Note how "cat" and "ssh" act as filters</span>
cat alarm2mcas-1.0.jar | ssh root@135.1.136.193 <span class="org-sh-escaped-newline">\</span>
    <span class="org-string">'ssh root@10.102.1.126 \</span>
<span class="org-string">        "cat - &gt; alarm2mcas-1.0.jar &amp;&amp; \</span>
<span class="org-string">         scp ./alarm2mcas*.jar 0-0-2:/path/to/lib/extensions/"'</span>
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Always set pipefail</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Note that this is necessary even if you already set errexit.
</p>

<pre class="example">
$ cat file_non_existant | while read line; do echo got $line; done
cat: file_non_existant: No such file or directory

$ echo $?
0

$ set -o pipefail

$ cat file_non_existant | while read line; do echo got $line; done
cat: file_non_existant: No such file or directory

$ echo $?
1
</pre>

<blockquote>
<p>
If set, the return value of a pipeline is the value of the last (rightmost)
command which exits with a non-zero status, or zero if all commands in the
pipeline exit successfully.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Piped blocks run in subshell</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Example 1</span>
<span class="org-builtin">echo</span> <span class="org-string">"hi there"</span> | <span class="org-builtin">read</span> var
<span class="org-builtin">echo</span> $<span class="org-variable-name">var</span>                       <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, prints nothing</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Example 2</span>
<span class="org-builtin">echo</span> <span class="org-string">"hello world"</span> | <span class="org-keyword">while </span><span class="org-builtin">read</span> line; <span class="org-keyword">do</span>
    <span class="org-variable-name">var</span>=<span class="org-string">'foo'</span>
    <span class="org-builtin">echo</span> <span class="org-string">"in: $var"</span>             <span class="org-comment-delimiter"># </span><span class="org-comment">OK, prints 'hello world'</span>
<span class="org-keyword">done</span>
<span class="org-builtin">echo</span> <span class="org-string">"out: $var"</span>                <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, prints nothing</span>
</pre>
</div>

<p>
Solution (courtesy of Stanley): use '&lt;' etc.
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="org-keyword">while </span><span class="org-builtin">read</span> line; <span class="org-keyword">do</span>
    <span class="org-variable-name">var</span>=<span class="org-string">'foo'</span>
    <span class="org-builtin">echo</span> <span class="org-string">"in: $var"</span>
<span class="org-keyword">done</span> &lt;&lt;&lt;<span class="org-string">"value"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Pipe sign is a sequence point</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">

<pre class="src src-shell-script">p1 2&gt;&amp;1 &gt; a.log                 <span class="org-comment-delimiter"># </span><span class="org-comment">does NOT work as expected</span>
p1 2&gt;&amp;1 | tee a.log             <span class="org-comment-delimiter"># </span><span class="org-comment">works</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Input and output</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> stdout != stderr</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Error messages go to stderr. Otherwise

<ul class="org-ul">
<li>Case 1
<div class="org-src-container">

<pre class="src src-shell-script">mycmd                           <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, log messages flush</span>
mycmd &gt;/dev/null                <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, error message discarded</span>
</pre>
</div>
</li>

<li>Case 2
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">set</span> -e                          <span class="org-comment-delimiter"># </span><span class="org-comment">Make this shell exit on error</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
<span class="org-variable-name">result</span>=$(<span class="org-sh-quoted-exec">mycmd</span>)                 <span class="org-comment-delimiter"># </span><span class="org-comment">OOPS, when mycmd fails, error message is</span>
                                <span class="org-comment-delimiter"># </span><span class="org-comment">stored in result, but is not printed on</span>
                                <span class="org-comment-delimiter"># </span><span class="org-comment">screen.</span>
debug <span class="org-string">"$result"</span>
</pre>
</div>
</li>
</ul>
</li>

<li>Buffered versus un-buffered.
</li>

<li>stdin/stdout vs <code>/dev/tty</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Temporary files</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Possible issues of temporary files

<ul class="org-ul">
<li>Initialize and clean up needed and incur failures

<ul class="org-ul">
<li>Fail to create the file: no permission.
</li>

<li>Fail to initialize the file: forget or no permission to remove/truncate
the file.
</li>

<li>File name collision: different applications use the same file name, or
multiple instances acccess the same file simultaneously.
</li>

<li>Garbage left in system: forget or fail to delete the file.
</li>
</ul>
</li>

<li>Extra disk space needed: to store temporary files.
</li>

<li>Performance drop: read/write from/to hard disk.
</li>
</ul>
</li>

<li>Tips with regards temporary files

<ol class="org-ol">
<li>Aviod temporary files when possible, use pipe instead.
</li>

<li>Put temporary files under <code>$TMP</code> (<code>/tmp/</code> if <code>TMP</code> is not set) so that
temporary files do not scatter all arround the system.
</li>

<li>Use command <code>mktemp</code> to ensue each temporary file has a uniq file name.
<ul class="org-ul">
<li>At least, use <code>tmplate$$</code> if <code>mktemp</code> not available
</li>
</ul>
</li>
</ol>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Use "Here Document"</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if</span> blahblah; <span class="org-keyword">then</span>
    cat &lt;&lt;EOF
<span class="org-sh-heredoc">One "here document" instead of multiple echo</span>
<span class="org-sh-heredoc">Starts from beginning of line</span>
<span class="org-sh-heredoc">EOF</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<ul class="org-ul">
<li>Starts from <b>the very beginning</b> of line
<ul class="org-ul">
<li>No indention allowed for delimiter
</li>
<li>Leading white space in content is preserved in output
</li>
</ul>
</li>

<li>Can use any delimiter

<div class="org-src-container">

<pre class="src src-shell-script">cat &lt;&lt;!!!
NOTE: I do NOT recommend using <span class="org-string">"!!!"</span> as a delimiter
<span class="org-negation-char">!</span>!!
</pre>
</div>
</li>

<li>Ignore leading TABs with <code>&lt;&lt;-</code> (<b>BAD idea!</b>)

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if</span> blahblah; <span class="org-keyword">then</span>
    cat &lt;&lt;-EOF
<span class="org-sh-heredoc">        Leading TABs are removed in the output</span>
<span class="org-sh-heredoc">        But white space are kept</span>
<span class="org-sh-heredoc">        Makes it error-prone</span>
<span class="org-sh-heredoc">    EOF</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
The TABs may be converted to white space inadvertently, rendering the
script grammatically incorrect.
</p>
</li>

<li>Quote delimiter to prevent variables from being expanded

<pre class="example">
$ i=foo
$ bash &lt;&lt;EOF
&gt; i=bar
&gt; echo $i
&gt; EOF
foo
$ bash &lt;&lt; 'EOF'
&gt; i=bar
&gt; echo $i
&gt; EOF
bar
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> getopts</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>The difference between <code>?</code> and <code>\?</code>.
</li>

<li>The usage of <code>OPTIND</code>.

<p>
OPTIND is not automatically reset. Hence, do remember to reset OPTIND
before (to ensure getopts work as expected) and after (in case others
forget to do so) getopts.
</p>
</li>

<li>Usually we do NOT add a leading ":" in OPTSTRING which puts getopts into
silent mode (refer to bash manual for more details).
</li>
</ul>

<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr"> 1: </span><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class="org-keyword">function</span> <span class="org-function-name">main</span> {
<span class="linenr"> 4: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">Reset OPTIND to ensure getopts work as expected. This is especially</span>
<span class="linenr"> 5: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">important in functions.</span>
<span class="linenr"> 6: </span>    <span class="org-variable-name">OPTIND</span>=1
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span>    <span class="org-builtin">local</span> <span class="org-variable-name">optstring</span>=<span class="org-string">"ndst:"</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">First round, set flags before performing any task</span>
<span class="linenr">11: </span>    <span class="org-keyword">while </span><span class="org-builtin">getopts</span> $<span class="org-variable-name">optstring</span> opt; <span class="org-keyword">do</span>
<span class="linenr">12: </span>        <span class="org-keyword">case</span> $<span class="org-variable-name">opt</span><span class="org-keyword"> in</span>
<span class="linenr">13: </span>            n) <span class="org-builtin">echo</span> set_dry_run_flag;; <span class="org-comment-delimiter"># </span><span class="org-comment">no-test</span>
<span class="linenr">14: </span>            t) <span class="org-builtin">echo</span> <span class="org-variable-name">target</span>=<span class="org-string">"$OPTARG"</span>;;
<span class="linenr">15: </span>            <span class="org-string">\?</span>) <span class="org-keyword">exit</span> 1;;
<span class="linenr">16: </span>            <span class="org-comment-delimiter"># </span><span class="org-comment">NOTE: putting "*)" or "?)" at the end also works, think the</span>
<span class="linenr">17: </span>            <span class="org-comment-delimiter"># </span><span class="org-comment">differences</span>
<span class="linenr">18: </span>        <span class="org-keyword">esac</span>
<span class="linenr">19: </span>    <span class="org-keyword">done</span>
<span class="linenr">20: </span>
<span class="linenr">21: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">Done with options, deal with arguments if needed</span>
<span class="linenr">22: </span>    <span class="org-builtin">shift</span> $((OPTIND - 1))
<span class="linenr">23: </span>
<span class="linenr">24: </span>    <span class="org-keyword">if</span> [ $<span class="org-variable-name">#</span> -ne 1 ]; <span class="org-keyword">then</span>
<span class="linenr">25: </span>        <span class="org-builtin">echo</span> <span class="org-string">"ERR: missing ..."</span> &gt;&amp;2
<span class="linenr">26: </span>        <span class="org-keyword">exit</span> 1
<span class="linenr">27: </span>    <span class="org-keyword">fi</span>
<span class="linenr">28: </span>
<span class="linenr">29: </span>    <span class="org-variable-name">var1</span>=<span class="org-string">"$1"</span>
<span class="linenr">30: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
<span class="linenr">31: </span>
<span class="linenr">32: </span>    <span class="org-builtin">echo</span> <span class="org-string">"=== Second round parsing ==="</span> <span class="org-comment-delimiter"># </span><span class="org-comment">This is usually not needed</span>
<span class="linenr">33: </span>
<span class="linenr">34: </span>    <span class="org-variable-name">OPTIND</span>=1                        <span class="org-comment-delimiter"># </span><span class="org-comment">reset OPTIND to reparse again</span>
<span class="linenr">35: </span>
<span class="linenr">36: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">Parse options and act accordingly</span>
<span class="linenr">37: </span>    <span class="org-keyword">while </span><span class="org-builtin">getopts</span> $<span class="org-variable-name">optstring</span> opt; <span class="org-keyword">do</span>
<span class="linenr">38: </span>        <span class="org-keyword">case</span> $<span class="org-variable-name">opt</span><span class="org-keyword"> in</span>
<span class="linenr">39: </span>            d) <span class="org-builtin">echo</span> do_backup_daily;;
<span class="linenr">40: </span>            s) <span class="org-builtin">echo</span> do_sync_repos;;
<span class="linenr">41: </span>            <span class="org-string">\?</span>) <span class="org-keyword">exit</span> 1;;
<span class="linenr">42: </span>        <span class="org-keyword">esac</span>
<span class="linenr">43: </span>    <span class="org-keyword">done</span>
<span class="linenr">44: </span>
<span class="linenr">45: </span>    <span class="org-comment-delimiter"># </span><span class="org-comment">Reset OPTIND in case others forget to do so.</span>
<span class="linenr">46: </span>    <span class="org-variable-name">OPTIND</span>=1
<span class="linenr">47: </span>}
<span class="linenr">48: </span>
<span class="linenr">49: </span>main <span class="org-string">"$@"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> read</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>Tricky when used in a pipe

<p>
Refer to <i>*Piped blocks run in subshell</i>
</p>
</li>

<li>Works with here string

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">read</span> first second third rest &lt;&lt;&lt; $<span class="org-variable-name">input</span>
</pre>
</div>
</li>

<li>Rest of the line get into the last var

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">read</span> first second third rest &lt;&lt;&lt; $<span class="org-variable-name">input</span>
<span class="org-builtin">read</span> var1 var2 &lt;&lt;&lt; $<span class="org-variable-name">input</span>
</pre>
</div>
<p>
var2 = second + third + rest
</p>
</li>

<li>This does NOT work

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">while </span><span class="org-builtin">read</span> line &lt; input.txt; <span class="org-keyword">do</span>
    something
<span class="org-keyword">done</span>
</pre>
</div>
</li>

<li>Assign a multi-line string to a variable

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">read</span> -d <span class="org-string">''</span> var &lt;&lt;EOF
<span class="org-sh-heredoc">And</span>
<span class="org-sh-heredoc">We needn't take care about quotes (' and ")</span>
<span class="org-sh-heredoc">EOF</span>
</pre>
</div>

<p>
NOTE: there must be a space after <code>-d</code>, please think about why.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> select</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">local</span> <span class="org-variable-name">IFS</span>=$<span class="org-string">'\n'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">In case session names contain whitespaces. Must</span>
                <span class="org-comment-delimiter"># </span><span class="org-comment">'local' to NOT pollute the global 'IFS'.</span>
                <span class="org-comment-delimiter"># </span><span class="org-comment">$'LITERAL_STR' =&gt; ansi-c quoting</span>
<span class="org-builtin">local</span> <span class="org-variable-name">PS3</span>=<span class="org-string">"Select a session: "</span>

<span class="org-keyword">select</span> session_name<span class="org-keyword"> in</span> $<span class="org-variable-name">sessions</span>; <span class="org-keyword">do</span>

    <span class="org-keyword">if</span> [ -n <span class="org-string">"$session_name"</span> ]; <span class="org-keyword">then</span> <span class="org-comment-delimiter"># </span><span class="org-comment">A valid choice</span>
        tmux -2 attach -t <span class="org-string">"$session_name"</span>
        <span class="org-keyword">return</span>
    <span class="org-keyword">else</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Invalid index '$REPLY', please retry"</span>
    <span class="org-keyword">fi</span>

<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> Open/close file descriptors</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr"> 1: </span><span class="org-comment-delimiter"># </span><span class="org-comment">open a new fd for both read &amp; write. The shell will find an unused fd number</span>
<span class="linenr"> 2: </span><span class="org-comment-delimiter"># </span><span class="org-comment">and store it in "fd"</span>
<span class="linenr"> 3: </span><span class="org-keyword">exec</span> {fd}&lt;&gt;input.txt
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class="org-keyword">while </span><span class="org-builtin">read</span> -u $<span class="org-variable-name">fd</span> line; <span class="org-keyword">do</span>
<span class="linenr"> 6: </span>    <span class="org-builtin">echo</span> <span class="org-string">"read: $line"</span>
<span class="linenr"> 7: </span><span class="org-keyword">done</span>
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span><span class="org-builtin">echo</span> <span class="org-string">"hello from test.sh"</span> &gt;&amp;$<span class="org-variable-name">fd</span>
<span class="linenr">10: </span><span class="org-keyword">exec</span> {fd}&lt;&amp;-                       <span class="org-comment-delimiter"># </span><span class="org-comment">close input fd</span>
<span class="linenr">11: </span>
<span class="linenr">12: </span><span class="org-comment-delimiter"># </span><span class="org-comment">Explicitly specify fd number</span>
<span class="linenr">13: </span><span class="org-keyword">exec</span> 3&lt;input.txt
<span class="linenr">14: </span><span class="org-builtin">read</span> -u 3 line
<span class="linenr">15: </span><span class="org-builtin">echo</span> $<span class="org-variable-name">line</span>
<span class="linenr">16: </span><span class="org-keyword">exec</span> 3&lt;&amp;-
<span class="linenr">17: </span>
<span class="linenr">18: </span><span class="org-comment-delimiter"># </span><span class="org-comment">save and restore a fd</span>
<span class="linenr">19: </span><span class="org-keyword">exec</span> {fd}&gt;&amp;1                    <span class="org-comment-delimiter"># </span><span class="org-comment">dup (save) stdout</span>
<span class="linenr">20: </span><span class="org-keyword">exec</span> &gt;/dev/null                 <span class="org-comment-delimiter"># </span><span class="org-comment">change stdout to discard everything</span>
<span class="linenr">21: </span><span class="org-builtin">echo</span> <span class="org-string">"hello null"</span>
<span class="linenr">22: </span><span class="org-keyword">exec</span> 1&gt;&amp;$<span class="org-variable-name">fd</span> {fd}&gt;&amp;-             <span class="org-comment-delimiter"># </span><span class="org-comment">restore stdout, close 3</span>
<span class="linenr">23: </span><span class="org-builtin">echo</span> <span class="org-string">"hello world"</span>
</pre>
</div>
</div>

<div id="outline-container-sec-5-7-1" class="outline-4">
<h4 id="sec-5-7-1"><span class="section-number-4">5.7.1</span> Note for ksh</h4>
<div class="outline-text-4" id="text-5-7-1">
<p>
In ksh, file descriptors created this way are private if they are greater
than 2 (see below). Use <code>( cmd &gt;&amp;3 ; ...) 3&gt;$log_file</code> or alike.
</p>

<blockquote>
<p>
exec [command [arg &#x2026;]]
  &#x2026;
</p>

<p>
If no command is given except for I/O redirection, the I/O redirection is
permanent and the shell is not replaced. Any file descriptors greater than 2
which are opened or dup(2)'d in this way are not made available to other
executed commands (i.e. commands that are not built-in to the shell).
</p>
</blockquote>
</div>
</div>

<div id="outline-container-sec-5-7-2" class="outline-4">
<h4 id="sec-5-7-2"><span class="section-number-4">5.7.2</span> Wholes in files</h4>
<div class="outline-text-4" id="text-5-7-2">
<p>
Be aware the risk when open files this way.
</p>

<p>
Usually, it seems ok to have multiple processes access a file simultaneously.
That is because those processes are not really modifying that file in
parallel.
</p>

<p>
When open a file this way, the file is kept open until the shell terminates,
hence largely increases the probability of creating wholes in the file.
</p>

<p>
Note that the following code snippet has the same issue.
</p>
<div class="org-src-container">

<pre class="src src-shell-script">(
    call_another_time_consuming_script
    or_call_a_sequence_of_commands
) &gt;log_file
</pre>
</div>

<p>
The key to reduce the risk is to minimize the durations that files being
opened.
</p>

<p>
One solution is to run an "internal logd" (courtesy of Wilson Liu, with
modification).
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">logger_err</span> {
    <span class="org-keyword">while </span><span class="org-builtin">read</span> line; <span class="org-keyword">do</span>
        <span class="org-builtin">echo</span> $<span class="org-variable-name">line</span> 1&gt;&amp;2
        <span class="org-builtin">echo</span> <span class="org-string">"$line"</span> &gt;&gt; $<span class="org-variable-name">logFile</span>
    <span class="org-keyword">done</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">logger</span> {
    <span class="org-keyword">while </span><span class="org-builtin">read</span> line; <span class="org-keyword">do</span>
        <span class="org-builtin">echo</span> <span class="org-string">"$line"</span> | tee -a $<span class="org-variable-name">logFile</span> &gt;&amp;2
    <span class="org-keyword">done</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">worker</span> {
    whatever_to_be_done
}

(worker | logger ) 2&gt;&amp;1 | logger_err
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> tee to file descriptors (fd)</h3>
<div class="outline-text-3" id="text-5-8">
<ol class="org-ol">
<li>If available, make use of the <code>/dev/fd</code> file sytem.
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">error messages go to both stderr and stdout</span>
<span class="org-builtin">echo</span> <span class="org-string">"ERRO: $@"</span> | tee /dev/stderr
<span class="org-comment-delimiter"># </span><span class="org-comment">go to stdout and a log file (opened with fd 3)</span>
<span class="org-builtin">echo</span> <span class="org-string">"ERRO: $@"</span> | tee /dev/fd/3
</pre>
</div>
</li>

<li>Otherwise, use subshell
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">IN ADDTION to stdout, error messages go to both fd 2 and 3</span>
<span class="org-builtin">echo</span> <span class="org-string">"ERRO: $@"</span> | tee &gt;(cat - &amp;2) &gt;(cat - &gt;&amp;3)
</pre>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9"><span class="section-number-3">5.9</span> Truncate files</h3>
<div class="outline-text-3" id="text-5-9">
<p>
Note that "echo" add a newline by default. Sometimes this could be an issue.
</p>

<pre class="example">
$ &gt; test.txt ; wc -l test.txt
0 test.txt

$ echo &gt; test.txt ; wc -l test.txt
1 test.txt

$ echo -n &gt; test.txt ; wc -l test.txt
0 test.txt
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Variables</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> There is NO type</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Everything is string and is converted according to operations:
</p>

<pre class="example">
$ [[ 010 -gt 009 ]] &amp;&amp; echo true || echo false
-bash: [[: 009: value too great for base (error token is "009")
false

$ [[ 010 &gt; 009 ]] &amp;&amp; echo true || echo false
true
</pre>

<p>
NOTE: refer to keyword <code>declare</code> in (info "(bash) Bash Builtins") for more
information such as integers, indexed/associated arrays.
</p>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Attributes of variables</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>local variables
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">local</span> <span class="org-variable-name">var</span>=<span class="org-string">"hi there"</span>
</pre>
</div>
</li>

<li>readonly variables
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">readonly</span> <span class="org-variable-name">var</span>=blahblah
</pre>
</div>
</li>

<li>automatically convert to lower-case/upper-case
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">declare</span> -u var
<span class="org-builtin">declare</span> -l <span class="org-variable-name">response</span>=yes
</pre>
</div>

<p>
This especially useful when reading response from users interactively.
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">declare</span> -l <span class="org-variable-name">response</span>=no
<span class="org-builtin">read</span> -p <span class="org-string">'Continue?(yes|no) '</span> response
<span class="org-keyword">if</span> [ <span class="org-string">"$response"</span> == <span class="org-string">"no"</span> ]; <span class="org-keyword">then</span>
    <span class="org-keyword">exit</span> 0
<span class="org-keyword">fi</span>
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> indirect expansion</h3>
<div class="outline-text-3" id="text-6-3">
<p>
<code>a=$(eval "echo \$$ref")</code> ?
</p>

<p>
For bash
</p>
<pre class="example">
$ var="hi there"

$ ref=var

$ echo ${!ref}
hi there
</pre>

<p>
For ksh
</p>
<pre class="example">
$ var1="foo bar"
$ var2="hello world"
$ nameref ref=var2
$ echo $ref
hello world
</pre>

<p>
See <a href="http://lgfang.github.io/computer/2015/04/15/sh-indirect-reference/">more discussion</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Processes</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Shebang</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Always start with <code>#!/bin/sh</code> or alike

<p>
Otherwise, what if a user runs the script in an incompatible shell?
</p>
</li>

<li>dos2unix or unix2dos

<pre class="example">
$ ./test.sh
-bash: ./test.sh: /bin/bash^M: bad interpreter: No such file or directory

$ file test.sh
test.sh: Bourne-Again shell script, ASCII text executable, with CRLF line terminators

$ dos2unix test.sh
dos2unix: converting file test.sh to Unix format ...

$ ./test.sh
hello world
</pre>
</li>

<li>Suggestion: Do NOT name files with suffix
<dl class="org-dl">
<dt> install_lab.sh </dt><dd>NO
</dd>
<dt> install_lab </dt><dd>YES
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> SUID does not work with scripts</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>For the sake of security, SUID does not work with shell scripts.

<div class="org-src-container">

<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;unistd.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;errno.h&gt;</span>

<span class="org-type">int</span> <span class="org-function-name">main</span>() {
    <span class="org-type">char</span>* <span class="org-variable-name">executable</span> = <span class="org-string">"testscript"</span>;
    execl (executable, executable, <span class="org-constant">NULL</span>);
    perror(<span class="org-string">"fail to exec"</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">exec returns == error occured</span>
    <span class="org-keyword">return</span> errno;
}
</pre>
</div>
</li>

<li><b>NOTE</b>, for bash, must add "-p".

<div class="org-src-container">

<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;unistd.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;errno.h&gt;</span>

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>* <span class="org-variable-name">argv</span>[]) {
    <span class="org-type">char</span>* <span class="org-variable-name">executable</span> = <span class="org-string">"/usr/local/bin/bash"</span>;
    execl (executable, executable, <span class="org-string">"-p"</span>,<span class="org-string">"./testscript"</span>, <span class="org-constant">NULL</span>);
    perror(<span class="org-string">"fail to exec"</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">exec returns == error occured</span>
    <span class="org-keyword">return</span> errno;
}
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> Evoke correct programs</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Always use absolute path

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-variable-name">ECHO</span>=/bin/echo
<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
$<span class="org-variable-name">ECHO</span> <span class="org-string">"that's it"</span>
/bin/rm tmp.txt
</pre>
</div>
</li>

<li>Or, overwrite PATH

<p>
Reset PATH to a minimal set of directories at the beginning of your scripts.
</p>
</li>

<li>Or, define functions to override the commands
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

<span class="org-keyword">function</span> <span class="org-function-name">awk</span>      { /bin/awk         <span class="org-string">"$@"</span>; }
<span class="org-keyword">function</span> <span class="org-function-name">basename</span> { /bin/basename    <span class="org-string">"$@"</span>; }
<span class="org-keyword">function</span> <span class="org-function-name">chmod</span>    { /bin/chmod       <span class="org-string">"$@"</span>; }
<span class="org-keyword">function</span> <span class="org-function-name">chown</span>    { /bin/chown       <span class="org-string">"$@"</span>; }
<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
</pre>
</div>
</li>

<li>Or, un-alias commands when calling them.

<p>
Otherwise, you'll get this(for bash scripts, you need not worry about
this):
</p>
<pre class="example">
$ alias echo='echo "do something nasty"'
$ echo foo
do something nasty
$ \echo foo
foo
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> Command line has length limitation</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Note that it is a command line limitation, hence
</p>
<ul class="org-ul">
<li>shell built-ins like <code>echo</code> not affected
</li>
<li>content sent via pipe not affected
</li>
</ul>

<pre class="example">
$ echo $0
-bash

$ getconf ARG_MAX
2097152

$ a=$(echo 1234567890{1..200000})

$ echo ${#a}
3288894

$ rm -f $a
-bash: /usr/bin/rm: Argument list too long

$ # Make use of xargs
$ echo $a | xargs rm -f

$ # split at whitespaces
$ for each in $a; do sth with $each; done

$ # split according to position
$ while [ ${#a} -gt 200000 ]; do sth ${a:0:200000}; a=${a:200000}; done
</pre>
</div>
</div>

<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> Inter-process lock</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>mkdir
<code>mkdir</code> is an atomic operation, can be used in shell scripts as lock.

<div class="org-src-container">

<pre class="src src-shell-script">mkdir lockDir 2&gt;/dev/null
<span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"no lock"</span>
    <span class="org-keyword">exit</span> 1
<span class="org-keyword">fi</span>
<span class="org-builtin">echo</span> <span class="org-string">"got lock"</span>
rmdir lockDir
</pre>
</div>
</li>

<li>flock

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">try_lock</span> {
    <span class="org-builtin">local</span> <span class="org-variable-name">lock_name</span>=<span class="org-string">"$1"</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">lock_file</span>=<span class="org-string">"/tmp/${lock_name}.lock"</span>
    <span class="org-builtin">local</span> lock_fd
    <span class="org-comment-delimiter"># </span><span class="org-comment">shellcheck disable=SC2093,SC1083</span>
    <span class="org-keyword">exec</span> {lock_fd}&gt;$<span class="org-variable-name">lock_file</span>
    flock -e -n $<span class="org-variable-name">lock_fd</span>

    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
}

<span class="org-variable-name">my_name</span>=$(<span class="org-sh-quoted-exec">basename</span> $<span class="org-variable-name">0</span>)
<span class="org-keyword">if</span> <span class="org-negation-char">!</span> try_lock <span class="org-string">"$my_name"</span>; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"Another instance of $my_name already running"</span>
<span class="org-keyword">else</span>
    <span class="org-builtin">echo</span> <span class="org-string">"Got the lock."</span>
    <span class="org-builtin">echo</span> <span class="org-string">"And, the lock will be automatically released"</span>
    sleep 10
<span class="org-keyword">fi</span>
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-sec-7-5-1" class="outline-4">
<h4 id="sec-7-5-1"><span class="section-number-4">7.5.1</span> Note for ksh</h4>
<div class="outline-text-4" id="text-7-5-1">
<p>
In ksh, one has to do it this way since the reason mentioned in <i>here</i>.
</p>

<div class="org-src-container">

<pre class="src src-shell-script">(
    flock -e -n 9

    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> failed to grab the lock
    <span class="org-keyword">else</span>
        <span class="org-builtin">echo</span> got the lock
        <span class="org-comment-delimiter"># </span><span class="org-comment">do the job</span>
    <span class="org-keyword">fi</span>

) 9&gt;$<span class="org-variable-name">lock_file</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> Timeout a process</h3>
<div class="outline-text-3" id="text-7-6">
<p>
If command "timeout" available, maybe you want to use it.
</p>

<p>
Otherwise, here is a function from "expert shell scripting":
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-function-name">timeout</span>() {
    <span class="org-variable-name">waitfor</span>=5
    <span class="org-variable-name">command</span>=$<span class="org-variable-name">*</span>
    $<span class="org-variable-name">command</span> &amp;
    <span class="org-variable-name">commandpid</span>=$<span class="org-variable-name">!</span>
    (sleep $<span class="org-variable-name">waitfor</span> ; <span class="org-builtin">kill</span> -9 $<span class="org-variable-name">commandpid</span> &gt;/dev/null 2&gt;&amp;1) &amp;
    <span class="org-variable-name">watchdogpid</span>=$<span class="org-variable-name">!</span>
    <span class="org-variable-name">sleeppid</span>=$(<span class="org-sh-quoted-exec">ps</span> $<span class="org-variable-name">ppid</span> $<span class="org-variable-name">watchdogpid</span> | awk <span class="org-string">'{print $1}'</span>)
    <span class="org-builtin">wait</span> $<span class="org-variable-name">commandpid</span>
    <span class="org-builtin">kill</span> $<span class="org-variable-name">sleeppid</span> &gt;/dev/null 2&gt;&amp;1
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Misc</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Use better syntax/notation</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>Use <code>source</code> instead of <code>.</code>

<p>
So that it is much easier to search it.
</p>
</li>

<li>Use <code>$()</code> instead of <code>``</code> since

<ul class="org-ul">
<li>The former is easier to be spotted.
</li>

<li>The former does not incur an extra level of escaping. Therefore, is more
straightforward.
<pre class="example">
$ a=$(echo 'a b' | sed 's/ /\\t/'); echo "$a"
a\tb

$ a=`echo 'a b' | sed 's/ /\\t/'`; echo "$a"
a       b

$ a=`echo 'a b' | sed 's/ /\\\\t/'`; echo "$a"
a\tb
</pre>
</li>

<li>The former is easier to nest
</li>
</ul>
</li>

<li>Use shortcut expressions

<div class="org-src-container">

<pre class="src src-shell-script">./configure &amp;&amp; make &amp;&amp; make install
mkdir -p $<span class="org-variable-name">dest</span>/healthTools || errout <span class="org-string">"Failed ..."</span>
pilot_is_active &amp;&amp; <span class="org-builtin">echo</span> <span class="org-string">"active pilot"</span> || <span class="org-builtin">echo</span> <span class="org-string">"standby pilot"</span>

<span id="coderef-oops" class="coderef-off">find . -name <span class="org-string">'core*'</span> -o -name <span class="org-string">'debuginfo*'</span> -mtime -3 -exec ls -l {} <span class="org-string">\;</span></span>
</pre>
</div>

<p>
Note, however, sometimes, take <a href="#coderef-oops"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-oops');" onmouseout="CodeHighlightOff(this, 'coderef-oops');">this</a> for example, shortcut expressions may
incur surprises.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Regular expressions are greedy</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">echo</span> <span class="org-string">"abcd...doo"</span> | grep -o <span class="org-string">"a.*d"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">==&gt; abcd...d</span>
</pre>
</div>

<p>
A real world bug:
</p>
<pre class="example">
# expect header:
# &lt;cr&gt;&lt;lf&gt;&lt;lf&gt;^^^&lt;sid&gt;^&lt;year&gt;-&lt;month&gt;-&lt;day&gt;^xxx
 \r\n\n   .* [0-9][0-9][0-9][0-9]-[0-1][0-9]-[0-3][0-9] ...
          ^^ &lt;--- oops!
</pre>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Number literals not necessarily decimals</h3>
<div class="outline-text-3" id="text-8-3">
<ul class="org-ul">
<li>In bash:
<pre class="example">
$ a=010

$ echo $a
010

$ echo $((a))
8

$ [[ 010 -gt 9 ]] &amp;&amp; echo true || echo false
false
</pre>
</li>

<li>In ksh:
<pre class="example">
$ a=010
$ echo $a
010
$ echo $((a))
10
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> Command outputs may vary according env and result</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li>(Format of) Outputs may change due to env. For example: (man "ps")

<blockquote>
<p>
If ps can not determine display width, as when output is redirected (piped)
into a file or another command, the output width is undefined (it may be 80,
unlimited, determined by the TERM variable, and so on). The COLUMNS
environment variable or &#x2013;cols option may be used to exactly determine the
width in this case. The w or -w option may be also be used to adjust width.
</p>
</blockquote>
</li>

<li>Outputs may "change" to due the content of it. E.g. (man "netstat")

<blockquote>
<p>
-T &#x2013;notrim
   Stop trimming long addresses.
</p>

<p>
&#x2013;wide , -W
   Do not truncate IP addresses by using output as wide as needed. This is optional for now to not break existing scripts.
</p>
</blockquote>

<p>
Btw., "netstat" is obsoleted, use "ss" instead.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> Avoid name space contamination by running in subshells</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">MY_VAR is still invisible afterwards</span>
(<span class="org-builtin">source</span> test.sh &amp;&amp; <span class="org-builtin">echo</span> $<span class="org-variable-name">MY_VAR</span>) 

<span class="org-comment-delimiter"># </span><span class="org-comment">Eevrything in test.sh come together with MY_VAR</span>
<span class="org-builtin">source</span> test.sh &amp;&amp; <span class="org-builtin">echo</span> $<span class="org-variable-name">MY_VAR</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Q&amp;A</h2>
<div class="outline-text-2" id="text-9">
<p>
Thanks
</p>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Misc. Techniques</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Shell parameter expansion</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">

<pre class="src src-shell-script">${<span class="org-variable-name">PARAMETER</span>:-WORD}
${#<span class="org-variable-name">PARAMETER</span>}
${<span class="org-variable-name">PARAMETER</span>#WORD}
${<span class="org-variable-name">PARAMETER</span>##WORD}
${<span class="org-variable-name">PARAMETER</span>%WORD}
${<span class="org-variable-name">PARAMETER</span>%%WORD}
${<span class="org-variable-name">PARAMETER</span>/PATTERN/STRING}
</pre>
</div>

<pre class="example">
$ v1=ABCD; echo ${v1,,}
abcd

$ v2=efgh; echo ${v2^^}
EFGH
</pre>

<p>
For more details, (info "(bash) Shell Parameter Expansion")
</p>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> Brace expansion</h3>
<div class="outline-text-3" id="text-10-2">
<p>
In addition to parameter expansion, there is also brace expansion
</p>

<pre class="example">
$ echo {one,two,three}
one two three

$ echo {1..9}
1 2 3 4 5 6 7 8 9

$ echo {1..9..3}
1 4 7

$ echo foo_{1,3,5}_bar
foo_1_bar foo_3_bar foo_5_bar

$ scp lgfang@remote:{path1/to/file1,path2/to/file2} ./
</pre>
</div>
</div>

<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> Make use of Non-op colon(:)</h3>
<div class="outline-text-3" id="text-10-3">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">validate</span>{
    :
}

<span class="org-keyword">if</span> xxx; <span class="org-keyword">then</span>
    :
<span class="org-keyword">else</span>
    Do sth.
<span class="org-keyword">fi</span>

<span class="org-keyword">while</span> :; <span class="org-keyword">do</span>
        Do sth.
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> Get N-th field</h3>
<div class="outline-text-3" id="text-10-4">
<ul class="org-ul">
<li>Here string

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">read</span> x x third rest &lt;&lt;&lt; $<span class="org-variable-name">input</span>
</pre>
</div>
</li>

<li>Define a function
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">third</span> {
    <span class="org-builtin">echo</span> <span class="org-string">"$3"</span>
}

<span class="org-variable-name">input</span>=<span class="org-string">"a b c d"</span>
third $<span class="org-variable-name">input</span>                    <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; c</span>

<span class="org-keyword">function</span> <span class="org-function-name">nth</span> {
    <span class="org-comment-delimiter"># </span><span class="org-comment">get the nth field of the input</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">index</span>=<span class="org-string">"$1"</span>
    <span class="org-builtin">shift</span>
    <span class="org-builtin">echo</span> ${<span class="org-variable-name">!</span>index}
}

nth 2 $<span class="org-variable-name">input</span>                     <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; b</span>
</pre>
</div>
</li>

<li>Or, use "array" of bash
<div class="org-src-container">

<pre class="src src-shell-script"><span class="linenr">1: </span><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>
<span class="linenr">2: </span><span class="org-variable-name">FIELD_A</span>=0
<span class="linenr">3: </span><span class="org-variable-name">FIELD_B</span>=1
<span class="linenr">4: </span><span class="org-variable-name">FIELD_C</span>=2
<span class="linenr">5: </span><span class="org-comment-delimiter">#</span><span class="org-comment">...</span>
<span class="linenr">6: </span><span class="org-variable-name">ATTRS</span>=(a b c)
<span class="linenr">7: </span><span class="org-builtin">echo</span> <span class="org-string">"Value of field A is ${ATTRS[$FIELD_A]}"</span>
<span class="linenr">8: </span><span class="org-builtin">echo</span> <span class="org-string">"Value of field B is ${ATTRS[$FIELD_B]}"</span>
<span class="linenr">9: </span><span class="org-builtin">echo</span> <span class="org-string">"Value of field C is ${ATTRS[$FIELD_C]}"</span>
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> Tell if A is an element of B</h3>
<div class="outline-text-3" id="text-10-5">
<p>
Use array instead of this if possible.
</p>

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">bash 4.2</span>
<span class="org-keyword">function</span> <span class="org-function-name">is_element_of</span> {
    <span class="org-builtin">local</span> <span class="org-variable-name">var</span>=<span class="org-string">"$1"</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">list</span>=<span class="org-string">"$2"</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">pattern</span>=<span class="org-string">"\b${var}\b"</span>

    <span class="org-keyword">if</span> [[ <span class="org-string">"$list"</span> =~ $<span class="org-variable-name">pattern</span> ]]; <span class="org-keyword">then</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">NOTE: do not quote $pattern, reason:</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">http://stackoverflow.com/questions/218156/bash-regex-with-quotes</span>
        <span class="org-keyword">return</span> 0
    <span class="org-keyword">else</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
}
</pre>
</div>

<pre class="example">
$ is_element_of 0-0-1 "0-0-2 0-0-11" &amp;&amp; echo yes

$ is_element_of 0-0-11 "0-0-2 0-0-11" &amp;&amp; echo yes
yes
</pre>
</div>
</div>

<div id="outline-container-sec-10-6" class="outline-3">
<h3 id="sec-10-6"><span class="section-number-3">10.6</span> Return values from functions</h3>
<div class="outline-text-3" id="text-10-6">
<p>
output parameter
</p>
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">my_fun</span> {
    <span class="org-variable-name">var_name</span>=$<span class="org-variable-name">1</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">leading underscore to avoid name conflict. If called as 'my_fun _result',</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">the caller will not see the change of '_result' because it is local to</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">my_fun.</span>
    <span class="org-variable-name">_result</span>=<span class="org-string">"value from my_fun"</span>

    <span class="org-builtin">eval</span> <span class="org-string">"var_name='$_result'"</span>
}

my_fun out
<span class="org-builtin">echo</span> $<span class="org-variable-name">out</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-7" class="outline-3">
<h3 id="sec-10-7"><span class="section-number-3">10.7</span> Logging functions</h3>
<div class="outline-text-3" id="text-10-7">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-builtin">unset</span> _LOG_FILE           <span class="org-comment-delimiter"># </span><span class="org-comment">ensure log goes to stdout util logging setup</span>

<span class="org-keyword">function</span> <span class="org-function-name">log</span> {
    <span class="org-comment-delimiter"># </span><span class="org-comment">1. Do not quote "LOG_FILE", so that if it is unset, 'tee' simply copy</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">input to output.</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">2. Do not use this function directly, use one of the wrappers below.</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">level</span>=$<span class="org-variable-name">1</span>
    <span class="org-builtin">shift</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">message</span>=<span class="org-string">"$*"</span>
    <span class="org-builtin">echo</span> <span class="org-string">"$(</span><span class="org-sh-quoted-exec">date</span><span class="org-string"> +'%y-%m-%d %H:%M:%S') $level: $message"</span> | tee -a $<span class="org-variable-name">_LOG_FILE</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">error_out</span> {
    error <span class="org-string">"$*"</span>
    <span class="org-keyword">exit</span> 1
}

<span class="org-keyword">function</span> <span class="org-function-name">error</span> {
    log ERRO <span class="org-string">"$*"</span> &gt;&amp;2
}

<span class="org-keyword">function</span> <span class="org-function-name">warn</span> {
    log WARN <span class="org-string">"$*"</span> &gt;&amp;2
}


<span class="org-keyword">function</span> <span class="org-function-name">info</span> {
    log INFO <span class="org-string">"$*"</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">debug</span> {
    log DEBUG <span class="org-string">"$*"</span> &gt;/dev/null <span class="org-comment-delimiter"># </span><span class="org-comment">record in log file only</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-8" class="outline-3">
<h3 id="sec-10-8"><span class="section-number-3">10.8</span> Wrappers for ssh</h3>
<div class="outline-text-3" id="text-10-8">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">ssh_run</span> {
    debug <span class="org-string">"ssh '$1' '$2'"</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">shellcheck disable=SC2029</span>
    ssh -o <span class="org-variable-name">StrictHostKeyChecking</span>=no -o <span class="org-variable-name">BatchMode</span>=yes -q -tt <span class="org-string">"$1"</span> <span class="org-string">"$2"</span>
}


<span class="org-keyword">function</span> <span class="org-function-name">ssh_checked_run</span> {
    <span class="org-variable-name">msg</span>=$(<span class="org-sh-quoted-exec">ssh_run</span> $<span class="org-variable-name">1</span> <span class="org-string">"$2"</span> |&amp; tr <span class="org-string">'\n'</span> <span class="org-string">'\\'</span>)

    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
        error_out <span class="org-string">"Failed on $1 '$2' $msg"</span>
    <span class="org-keyword">fi</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-9" class="outline-3">
<h3 id="sec-10-9"><span class="section-number-3">10.9</span> Ask for users confirm</h3>
<div class="outline-text-3" id="text-10-9">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">function</span> <span class="org-function-name">confirm</span> {
    <span class="org-builtin">local</span> <span class="org-variable-name">prompt</span>=<span class="org-string">"$1 (yes or no)? [no]: "</span>
    <span class="org-builtin">declare</span> -l <span class="org-variable-name">resp</span>=<span class="org-string">''</span>

    <span class="org-keyword">while</span> [ <span class="org-string">"$resp"</span> != <span class="org-string">'no'</span> -a <span class="org-string">"$resp"</span> != <span class="org-string">"yes"</span> ]; <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ -n <span class="org-string">"$resp"</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">echo</span> <span class="org-string">"Invalid input, please try again"</span>
        <span class="org-keyword">fi</span>

        <span class="org-builtin">read</span> -p <span class="org-string">"$prompt"</span> resp
        [ -n <span class="org-string">"$resp"</span> ] || <span class="org-variable-name">resp</span>=<span class="org-string">'no'</span>
    <span class="org-keyword">done</span>

    <span class="org-keyword">if</span> [ <span class="org-string">"$resp"</span> == <span class="org-string">'yes'</span> ]; <span class="org-keyword">then</span>
        <span class="org-keyword">return</span> 0
    <span class="org-keyword">else</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
}
</pre>
</div>

<pre class="example">
$ if confirm 'Do you want to continue?'; then echo go on; fi
Do you want to continue? (yes or no)? [no]:

$ if confirm 'Do you want to continue?'; then echo go on; fi
Do you want to continue? (yes or no)? [no]: Yes
go on
</pre>
</div>
</div>

<div id="outline-container-sec-10-10" class="outline-3">
<h3 id="sec-10-10"><span class="section-number-3">10.10</span> To tell if a bash function exists or not</h3>
<div class="outline-text-3" id="text-10-10">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if </span><span class="org-builtin">declare</span> -f funname &gt;/dev/null; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"funname defined"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-11" class="outline-3">
<h3 id="sec-10-11"><span class="section-number-3">10.11</span> To tell if it is an interactive shell</h3>
<div class="outline-text-3" id="text-10-11">
<p>
This is freequently used in <code>.bashrc</code>
</p>

<ol class="org-ol">
<li>This one seems most portable. It tests if stdin is tty

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if</span> [ -t 0 ]; <span class="org-keyword">then</span> <span class="org-comment-delimiter"># </span><span class="org-comment">interactive shell</span>
    stty erase <span class="org-string">"^?"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">kill "^U" intr "^C" eof "^D"</span>
    <span class="org-builtin">set</span> -o ignoreeof  <span class="org-comment-delimiter"># </span><span class="org-comment">do not logout when "ctrl + D" pressed</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</li>

<li>This one should work in both ksh and bash
and is recommended by bash manual.
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if</span> [[ $<span class="org-variable-name">-</span> = *i* ]]; <span class="org-keyword">then</span>
   <span class="org-comment-delimiter"># </span><span class="org-comment">do interactive stuff</span>
<span class="org-keyword">fi</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Or</span>
<span class="org-keyword">case</span> <span class="org-string">"$-"</span><span class="org-keyword"> in</span>
 *i*) <span class="org-builtin">echo</span> This shell is interactive ;;
 *)   <span class="org-builtin">echo</span> This shell is not interactive ;;
<span class="org-keyword">esac</span>
</pre>
</div>
</li>

<li>This one does not always work, since PS1 may be set after the test.

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-keyword">if</span> [ -z <span class="org-string">"$PS1"</span> ]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> This shell is not interactive
<span class="org-keyword">else</span>
    <span class="org-builtin">echo</span> This shell is interactive
<span class="org-keyword">fi</span>
</pre>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-10-12" class="outline-3">
<h3 id="sec-10-12"><span class="section-number-3">10.12</span> Socket</h3>
<div class="outline-text-3" id="text-10-12">
<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-variable-name">web_server</span>=<span class="org-string">'ihgpweb.ih.xxxxxx.com'</span>
<span class="org-variable-name">web_page</span>=<span class="org-string">'~lgfang/code/sh-scripting.html'</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">exec {file-descriptor}&lt;&gt;/dev/{protocol}/{host}/{port}</span>
<span class="org-keyword">exec</span> 3&lt;&gt;/dev/tcp/$<span class="org-variable-name">web_server</span>/80
<span class="org-builtin">echo</span> -e <span class="org-string">"GET /$web_page HTTP/0.9\r\n"</span> &gt;&amp;3 &amp;&amp; cat &lt;&amp;3
<span class="org-comment-delimiter">## </span><span class="org-comment">Or, For HTTP 1.1</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">echo -e "GET /$web_page HTTP/1.1\nhost:$web_server\r\n" &gt;&amp;3</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-13" class="outline-3">
<h3 id="sec-10-13"><span class="section-number-3">10.13</span> Use of "shortcut" expressions</h3>
<div class="outline-text-3" id="text-10-13">
</div><div id="outline-container-sec-10-13-1" class="outline-4">
<h4 id="sec-10-13-1"><span class="section-number-4">10.13.1</span> Continue with next command until one fails</h4>
<div class="outline-text-4" id="text-10-13-1">
<pre class="example">
$ ./cmd 1 0 &amp;&amp; ./cmd 2 0 &amp;&amp; ./cmd 3 0
cmd1 succeeded
cmd2 succeeded
cmd3 succeeded

$ ./cmd 1 0 &amp;&amp; ./cmd 2 1 &amp;&amp; ./cmd 3 0
cmd1 succeeded
cmd2 failed

$ ./cmd 1 1 &amp;&amp; ./cmd 2 0 &amp;&amp; ./cmd 3 0
cmd1 failed
</pre>
</div>
</div>

<div id="outline-container-sec-10-13-2" class="outline-4">
<h4 id="sec-10-13-2"><span class="section-number-4">10.13.2</span> Try commands in turn until one succeeded:</h4>
<div class="outline-text-4" id="text-10-13-2">
<pre class="example">
$ ./cmd 1 0 || ./cmd 2 0 || ./cmd 3 0
cmd1 succeeded

$ ./cmd 1 1 || ./cmd 2 0 || ./cmd 3 0
cmd1 failed
cmd2 succeeded

$ ./cmd 1 1 || ./cmd 2 1 || ./cmd 3 0
cmd1 failed
cmd2 failed
cmd3 succeeded
</pre>
</div>
</div>

<div id="outline-container-sec-10-13-3" class="outline-4">
<h4 id="sec-10-13-3"><span class="section-number-4">10.13.3</span> Run either cmd2 or cmd3 according to result of cmd1</h4>
<div class="outline-text-4" id="text-10-13-3">
<pre class="example">
$ ./cmd 1 0 &amp;&amp; ./cmd 2 0 || ./cmd 3 0
cmd1 succeeded
cmd2 succeeded

$ ./cmd 1 1 &amp;&amp; ./cmd 2 0 || ./cmd 3 0
cmd1 failed
cmd3 succeeded
</pre>

<p>
<b>NOTE</b> in this case cmd2 and cmd3 are usually commands never fail. Otherwise
the result will be less straight forward.
</p>
<pre class="example">
$ ./cmd 1 0 &amp;&amp; ./cmd 2 1 || ./cmd 3 0
cmd1 succeeded
cmd2 failed
cmd3 succeeded
</pre>

<p>
To be accurate, this form of expression means: run cmd3 if any of cmd1 and
cmd2 failed.
</p>
</div>
</div>

<div id="outline-container-sec-10-13-4" class="outline-4">
<h4 id="sec-10-13-4"><span class="section-number-4">10.13.4</span> If either cmd1 or cmd2 succeeded, run cmd3.</h4>
<div class="outline-text-4" id="text-10-13-4">
<p>
Not that run cmd2 or not depends on cmd1's result
</p>

<pre class="example">
$ ./cmd 1 0 || ./cmd 2 0 &amp;&amp; ./cmd 3 0
cmd1 succeeded
cmd3 succeeded

$ ./cmd 1 1 || ./cmd 2 0 &amp;&amp; ./cmd 3 0
cmd1 failed
cmd2 succeeded
cmd3 succeeded

$ ./cmd 1 1 || ./cmd 2 1 &amp;&amp; ./cmd 3 0
cmd1 failed
cmd2 failed
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-14" class="outline-3">
<h3 id="sec-10-14"><span class="section-number-3">10.14</span> Why not "basename"</h3>
<div class="outline-text-3" id="text-10-14">
<p>
From <a href="http://unix.stackexchange.com/questions/94295/shellcheck-is-advising-not-to-use-basename-why?bcsi_scan_BB84AA71CA590268=7vzCsNZqiDXSg4MeLUJh7CDewsNEAAAAusGUgA==">stackoverflow</a>:
</p>

<blockquote>
<p>
It's not about efficiency, it's about correctness. basename uses newlines to
delimit the filenames it prints out. In the usual case when you only pass one
filename, it adds a trailing newline to its output. Since filenames may
contain newlines themselves, this makes it difficult to correctly handle
these filenames.
</p>

<p>
It's further complicated by the fact that people usually use basename like
this: "$(basename "$file")". This makes things even more difficult, because
$(command) strips all trailing newlines from command. Consider the unlikely
case that $file ends with a newline. Then basename will add an extra newline,
but "$(basename "$file")" will strip both newlines, leaving you with an
incorrect filename.
</p>

<p>
Another problem with basename is that if $file begins with a - (dash a.k.a.
minus), it will be interpreted as an option. This one is easy to fix:
$(basename &#x2013; "$file")
</p>

<p>
The robust way of using basename is this:
</p>

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-comment-delimiter"># </span><span class="org-comment">A file with three trailing newlines.</span>
<span class="org-variable-name">file</span>=$<span class="org-string">'/tmp/evil\n\n\n'</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Add an 'x' so we can tell where $file's newlines end and basename's begin.</span>
<span class="org-variable-name">file_x</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">basename</span><span class="org-string"> -- "$file"; printf x)"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Strip off the 'x' added by us and the newline added by basename.</span>
<span class="org-variable-name">base</span>=<span class="org-string">"${file_x%??}"</span>
</pre>
</div>

<p>
An alternative is to use ${file##*/}, which is easier but has bugs of its
own. In particular, it's wrong in the cases where $file is / or foo/.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-sec-10-15" class="outline-3">
<h3 id="sec-10-15"><span class="section-number-3">10.15</span> Array</h3>
<div class="outline-text-3" id="text-10-15">
<ul class="org-ul">
<li>remove elements from an array based on index

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-variable-name">arr</span>=(a b c d e)
<span class="org-variable-name">idx</span>=2

<span class="org-variable-name">arr</span>=(${<span class="org-variable-name">arr</span>[@]:0:$<span class="org-variable-name">idx</span>} ${<span class="org-variable-name">arr</span>[@]:$((idx+1))})
</pre>
</div>

<p>
NOTE: <code>unset arr[idx]</code> does not re-arrange subscripts of elements.
</p>
</li>

<li>remove elements from an array based on value

<div class="org-src-container">

<pre class="src src-shell-script"><span class="org-variable-name">elem</span>=<span class="org-string">"todel"</span>
<span class="org-builtin">local</span> <span class="org-variable-name">tmp</span>=()

<span class="org-keyword">for</span> each<span class="org-keyword"> in</span> <span class="org-string">"${arr[@]}"</span>; <span class="org-keyword">do</span>
    [ <span class="org-string">"$each"</span> != <span class="org-string">"$elem"</span> ] &amp;&amp; <span class="org-variable-name">tmp</span>+=(<span class="org-string">"$each"</span>)
<span class="org-keyword">done</span>

<span class="org-variable-name">arr</span>=(<span class="org-string">"${tmp[@]}"</span>)
<span class="org-builtin">unset</span> tmp
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

     <br/>
     <p>
     <span class="date">Created: 2016-08-01 Mon 15:02</span> by <span class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</span>
     </p>

     <!-- DISQUS  -->
     <div id="disqus_thread"></div>
     <script type="text/javascript">
         /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
         var disqus_shortname = 'lgfang'; // required: replace example with your forum shortname

         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
     </script>
     <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
     <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

     <!-- google analytic -->
     <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

       ga('create', 'UA-84711243-1', 'auto');
       ga('send', 'pageview');

     </script>
</div>
</div>
</body>
</html>
